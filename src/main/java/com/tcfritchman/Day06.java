package com.tcfritchman;

import java.util.ArrayList;
import java.util.List;

public class Day06 {

    static String exampleInput = """
            ....#.....
            .........#
            ..........
            ..#.......
            .......#..
            ..........
            .#..^.....
            ........#.
            #.........
            ......#...
            """;

    static String realInput = """
            ...#....#................................#..........................#..........#.............#..#.................................
            .......#........................#.......#......................#............#.....................................................
            ..#......#....................................................................................#.......#................#..........
            ..................#...........#...#..#............................#.........#...................#...............................#.
            ..#...................................................................................................................#....#......
            ............#.............................#......................#.......#...........#..................##..............#.........
            ..............................#................................................#.............................................#....
            ....................#.#...........#...#....#..............#.........#.........#..................#...........#.................#..
            .#........................................................................#.....#.......##.....................#..................
            .#........................#..................................#............................#...#..........#.......#.............#..
            ................................#......#...............#...........................#.............................#..#.#...#....#..
            ..........................................................#..........#..#.......#........#............#.................#.........
            ......#.......#......................................................................................#................#...........
            ##......#...................................................#................#............................#.......................
            .....#.................................................................#.....................#...............................#...#
            ...........................................................................................................#......................
            ........#......................#..........#..#....#....................#..##...........#..#.............................#.#......#
            #...#..................#.....................#...#...#.......................................................#.....#..............
            #...#..................#.#....#...............#...........#...................#.....##......................................#.....
            ......#............................................................................................#...#.#........................
            ......................................................#..............#.....#.....#..#...........#..............................#..
            .........................##.#..............#............#....................................................................##...
            ..#....................#...........................................................................................#......#.##....
            ..............#........#..#.......#................#.....#.......................................................................#
            .........#..........................#........#..........#...............#...................................#.............#.......
            ...........#.....................#.....#..............#......#.........................................#..........................
            .......##.............................#.........#...............#...............#..............................................#..
            .......#.....#.....#...........#............................................................................#..............#.....#
            ....#.............................................#....#....#....#...........................................##..............##...
            .#.............#.......#.....#.........#....#......#.............#............#......#............#......................#........
            ..................................................................................................#....#..........................
            .............................................#....................#...............................#.............#.................
            .........#...............#.....................#...............#......#.................................................#.........
            ..........#.................................................................................#..............#..............#.....#.
            .........................#........#.....#............#.....................#.......................................#..............
            .....................#.....................#..............................#..................................#..........#.........
            ........................#.....................#..............................#.#................#.................................
            .....................................................#...............#.......................................................#....
            .................#.......#......##..............................##.................#..........................#....#....#........#
            .............................#................................#..#...........#..........#.........................................
            .#...........................#........#.#...#...#....#......#......#...........#..................##.........................#....
            .......................................#......................................#................................................#..
            ..........##......#..............................................................#.......#....................#..#......#.........
            .#...............#............#....#....................................^......#.........................................#.#......
            .................#....................#..#....#.......................#.............................#.....#.....#............#....
            ...............................................................#...............##.................#........#.#....................
            ...................................#..#.........#.........#...............#.........#.......................................#.....
            .........................#......................................................................................#............#....
            .................................#............#............#.............................#........................................
            ..........#.........#...........................................#..#...#..#.......................................................
            .#....#....#..........................................#.....#..........................................................#..........
            ...#...............#......................................................................#.............................#.........
            ....#......................#...........#......................................#..............#...........................#........
            .......................................................#...........#.......#..............................#.......................
            ......#............#.#...........#............#...................#..................#................................##..........
            .......#..........................................................................................#.....................##........
            ....................................#.........#..................##....................#.#...........#......................#.....
            .........................#...............................................................#....................#...................
            ...............................#........................................................................#....................#....
            ..#.#.......................................................................#..........#.........#........#.......................
            ....#....#.....................#.............#..#........................#.............#.....#....................................
            ..#............................................................................#....................#.................#.....#.#...
            ..............................................#........#............##.#..............#...#...................#...................
            .............................#..................#..................#.................................#............................
            ......#................................#....#..................................#............#.....................................
            #..........#...#..................#...............................................................................................
            ......................................#......................................#.......#....#.......................................
            ......................................................................#......................................#...........##.....#.
            .......#.............#................................................#.....#..#......#......................................#....
            ..........................................#...............#...#........#..........................................................
            #..#......#..........#....#.......................................................................................................
            .......#..#............................................................#........#...#.#...........................................
            .#....#...#..#................................................#......................#............................................
            .........................#...........#..........#............#...............................#...#...#..................#.........
            ....#......................#......#.......#....................#..........................#...............................#.......
            .........................#...............#.........................#.........#..................................#.................
            ...............................#......................................................#...........................................
            ..................................................#.........................#...................#......#..........................
            ...................#.##..............................#................#........#..............................#...................
            .#.................#..............................#................#............................#............#................#...
            ............#..............#....................................#.....#.....#..........#................#.........................
            ...................#.............................#...........##...........................................#.......................
            .#.............##...........#............##...#.........................................................................#.......#.
            ........#................#....................#..........#....#.......#.#..............#..............#.................#.........
            ............................#..#...#..........................................................#......#............................
            .........#.................#......#.............................................#...##.....#.................................##...
            ............#..........................................................................#..........#...................#...........
            ....................................#.............#............#..................#....#.#.......................#...#............
            ......#...................................................##....................................................................#.
            ...............................#.............#.#...............#.......................................#.#.......................#
            ..........#............................#....#.#.#.#..............................................................#................
            ....#...#............#.#.................................................#.....................................#.#................
            ...........#...............................##.........#............#.....................#........................................
            ...................#.............................#.........#..............................................#.....#.................
            .........#................#.........#.............#.............#...#...........................................................#.
            .....#...........................#............##............#................#...............................#.............#..#...
            ................#.#.......#.................#...................................................#.........#..........##.#.........
            .........................#.................#...............#...........................#............#.............#..............#
            ...................#......#...........................#.....#.....................................................#...............
            ......#...........##......#..................#......#............##................................#..............................
            ....................#.........#...........................................................................................#....#..
            ................................................#....#.....#..#........................#....................##....................
            ........#...........#....#.......#..........##............................................#.......#.........#...#...............#.
            #.#.....#.#..............................................#...#...............#..........#................##.........#..........#.#
            #........................#...#.........#........#..............................................................#..................
            ..................................................................................................................................
            ...........................................#..#..........................................#...................#....................
            ...................#.............#.....#..................................................#...................................#...
            ................#...........................................................................#.#...#...............................
            ........#.......#......#...........................................#....................................#......#............#.....
            ...............#.......#....................#.....................................................................#...............
            ..............##....#.............................#......................#.....#......#........................................#..
            ............................#.........#.....................#.....................................................................
            #....................#...................##........#...#........#......#....#..........................................#.#.......#
            ..#............#...#...............................#.#....................#....................................#..............#...
            ..................#..#.......#......#.....#.......#.................#.....#...................................#.............#.....
            .......................#..............#.........#............#.......#.................................................#.....#....
            ................#.....................................................#.#.............................#.........#...........#.....
            ......................#.................................##..................................#.................................#...
            .......................................#........................................................................#.................
            .........#...........#..............#......................#................................#..#.......................#..........
            ...................#..................#...#....#......................................................#...........................
            ..............................#.........#................................#............................#...........................
            ........#....#...................................................................##........#......................................
            ..................................#...................#...................#.#.......#.............#..............................#
            .....................................#...##...............................................................................#.......
            ......................#.......#.............#.......................#..#.....#......................#.................#...........
            .....##...........#.......#................#.................................#...##......#......#...............#.......#.#.......
            .....#...#...............#......................#........#..........#..##...#...#........#..........#.............................
            #...........#.............#...............................#..............................#...#.#........#.........................
            """;

    public static void main(String[] args) {
        System.out.println("Part 1 --- example: " + part1(exampleInput));
        System.out.println("Part 1 --- real: " + part1(realInput));
        System.out.println("Part 2 --- example: " + part2(exampleInput));
        System.out.println("Part 2 --- real: " + part2(realInput));
    }

    private static Object part1(String input) {
        PatrolMap map = new PatrolMap(input);
        map.simulate();
        return map.getPositions().stream().filter(Position::isVisited).count();
    }

    private static Object part2(String input) {
        PatrolMap map = new PatrolMap(input);
        map.simulate();
        return map.getPositions()
                .stream()
                .filter(position -> position.isVisited() && !position.isStart())
                .map(position -> {
                    PatrolMap modifiedMap = new PatrolMap(input);
                    modifiedMap.obstruct(position.getX(), position.getY());
                    modifiedMap.simulate();
                    return modifiedMap;
                })
                // still within the grid after the simulation indicates a cycle
                .filter(PatrolMap::isWithinArea)
                .count();
    }

    static class PatrolMap {
        private final Position[][] grid;
        private final int width;
        private final int height;

        private int x;
        private int y;
        private int direction; // 0 == up, 1 == right, 2 == down, 3 == left

        PatrolMap(String input) {
            String[] lines = input.split("\n");
            width = lines[0].length();
            height = lines.length;
            grid = new Position[height][width];

            for (int row = 0; row < height; row++) {
                for (int col = 0; col < width; col++) {
                    grid[row][col] = new Position(col, row);
                    char c = lines[row].charAt(col);
                    if (c == '^') {
                        x = col;
                        y = row;
                        grid[row][col].setStart(true);
                    } else if (c == '#') {
                        grid[row][col].setObstructed(true);
                    }
                }
            }

        }

        void simulate() {
            int moves = 0;
            // limit the number of moves in case the path is cyclical
            while (isWithinArea() && moves < 20_000) {
                move();
                moves++;
            }
        }

        void move() {
            int nextX, nextY;
            if (direction == 0) {
                nextX = x;
                nextY = y - 1;
            } else if (direction == 1) {
                nextX = x + 1;
                nextY = y;
            } else if (direction == 2) {
                nextX = x;
                nextY = y + 1;
            } else {
                nextX = x - 1;
                nextY = y;
            }

            if (isWithinArea(nextX, nextY) && grid[nextY][nextX].isObstructed()) {
                // Turn right 90 degrees
                direction++;
                if (direction == 4) {
                    direction = 0;
                }
            } else {
                grid[y][x].setVisited(true);
                // Step forward
                x = nextX;
                y = nextY;
            }
        }

        boolean isWithinArea() {
            return isWithinArea(x, y);
        }

        private boolean isWithinArea(int x, int y) {
            return x >= 0 && x < width && y >= 0 && y < height;
        }

        List<Position> getPositions() {
            List<Position> positions = new ArrayList<>();
            for (int row = 0; row < height; row++) {
                for (int col = 0; col < width; col++) {
                    positions.add(grid[col][row]);
                }
            }
            return positions;
        }

        void obstruct(int x, int y) {
            grid[y][x].setObstructed(true);
        }
    }

    static class Position {
        private final int x;
        private final int y;

        private boolean obstructed;
        private boolean visited;
        private boolean start;

        public Position(int x, int y) {
            this.x = x;
            this.y = y;
        }

        public boolean isObstructed() {
            return obstructed;
        }

        public void setObstructed(boolean obstructed) {
            this.obstructed = obstructed;
        }

        public boolean isVisited() {
            return visited;
        }

        public void setVisited(boolean visited) {
            this.visited = visited;
        }

        public boolean isStart() {
            return start;
        }

        public void setStart(boolean start) {
            this.start = start;
        }

        public int getX() {
            return x;
        }

        public int getY() {
            return y;
        }
    }
}